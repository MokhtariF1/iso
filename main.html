<!DOCTYPE html>
<html lang="fa">

<head>
  <meta charset="UTF-8">
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø±Ø¬Ø¹ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‡Ø§</title>
  <script src="data.js"></script>
  <link href="style.css" rel="stylesheet" />
  <!-- <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">; -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js">
  </script>
  <style>

  </style>
</head>

<body>
  <h1>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø±Ø¬Ø¹ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‡Ø§</h1>

  <footer>
    <div>BNP Developer Group</div>
    <div id="liveDate"></div>
    <div>1.1</div>
  </footer>

  <div class="controls">
    <input type="text" id="search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ...">
    <select id="filter">
      <option value="all">......</option>
      <option value="quality">Ú©ÛŒÙÛŒØª</option>
      <option value="safety">Ø§ÛŒÙ…Ù†ÛŒ</option>
      <option value="environment">Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª</option>
      <option value="food">Ø§ÛŒÙ…Ù†ÛŒ ØºØ°Ø§ÛŒÛŒ</option>
      <option value="security">Ø§Ù…Ù†ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</option>
      <option value="cables">Ú©Ø§Ø¨Ù„</option>
      <option value="cable_tray">Ø³ÛŒÙ†ÛŒ Ú©Ø§Ø¨Ù„</option>
    </select>
    <button class="icon-btn" onclick="toggleDarkMode()" title="Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡/Ø±ÙˆØ´Ù†">
      <i id="themeIcon" data-lucide="moon"></i>
    </button>
    <button class="icon-btn" onclick="toggleDashboard()" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
      <i data-lucide="settings"></i>
    </button>
    <button class="icon-btn" onclick="downloadPDF()" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF">
      <i data-lucide="download"></i>
    </button>
    <label for="uploadTxt" class="icon-btn" title="Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ txt">
      <i data-lucide="file-plus"></i>
    </label>
    <input type="file" id="uploadTxt" accept=".txt" hidden />
    <button class="icon-btn" onclick="openProjectPanel()" title="Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§">
      <i data-lucide="folder-plus"></i>
    </button>
    <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø³ØªØ§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯ -->
    <button class="icon-btn" onclick="toggleFavorites()" title="Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§">
      <i id="favoritesIcon" data-lucide="star"></i>
    </button>
  </div>

  <!-- <div class="favorites-toggle">
    <button onclick="toggleFavorites()">Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ø§Ù‚Ù‡â€Œ Ù…Ù†Ø¯ÛŒâ€Œ Ù‡Ø§</button>
  </div> -->

  <div id="container"></div>
  <div class="pagination" id="pagination"></div>

  <div class="dashboard-panel" id="dashboardPanel">
    <h3>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h3>
    <ul>
      <li>ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§: <span id="totalCount">0</span></li>
      <li>â­ Ø¹Ù„Ø§Ù‚Ù‡â€Œ Ù…Ù†Ø¯ÛŒâ€Œ Ù‡Ø§: <span id="favCount">0</span></li>
      <li>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ¹Ù„ÛŒ: <span id="searchTerm">---</span></li>
      <li>ğŸ—‚ Ø¯Ø³ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨â€Œ Ø´Ø¯Ù‡: <span id="activeFilter">Ù‡Ù…Ù‡</span></li>
      <li>ğŸ“„ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ: <span id="currentPageInfo">1</span></li>
      <li><button onclick="toggleDashboard()"
          style="margin-top:10px;background:#f44336;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;width:100%">Ø¨Ø³ØªÙ†</button>
      </li>
    </ul>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ -->
  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ -->
  <div class="overlay" id="projectOverlay"></div>
  <div class="project-panel" id="projectPanel">
    <div class="project-panel-header">
      <h3 class="project-panel-title">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h3>
      <button class="close-panel" onclick="closeProjectPanel()">&times;</button>
    </div>

    <div id="projectFormContainer">
      <div class="form-group">
        <label for="projectName">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
        <input type="text" id="projectName" class="form-control" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
      </div>
      <div class="form-group">
        <label for="projectNumber">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡</label>
        <input type="text" id="projectNumber" class="form-control" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
      </div>
      <div class="form-group">
        <label for="projectDescription">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
        <textarea id="projectDescription" class="form-control" rows="3"
          placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± Û· Ø®Ø·)"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveProject()">Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    </div>

    <div id="projectDetailsContainer" style="display: none;">
      <div class="projects-list" id="projectsList">
        <!-- Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
      </div>

      <button class="btn btn-primary" onclick="showNewProjectForm()" style="margin-top: 20px;">Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</button>

      <div id="standardsContainer" style="margin-top: 30px;">
        <h4 id="currentProjectTitle"></h4>
        <p id="currentProjectDescription"></p>

        <div class="add-standard-form">
          <input type="text" id="standardSearch" class="form-control" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯...">
          <button class="btn btn-primary" onclick="searchStandard()">Ø¬Ø³ØªØ¬Ùˆ</button>
        </div>

        <div id="searchResults" style="margin-top: 15px; display: none;">
          <h6>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h6>
          <div id="searchResultsList"></div>
        </div>

        <div class="standards-list" id="standardsList" style="margin-top: 20px;">
          <!-- Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <div class="export-options" style="margin-top: 20px;">
          <button class="btn btn-secondary" onclick="exportToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button class="btn btn-secondary" onclick="exportToPDF()">Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const itemsPerPage = 15;
    let currentPage = 1;
    let showFavoritesOnly = false;
    let currentProject = null;
    let currentPhase = null;

    const container = document.getElementById("container");
    const searchInput = document.getElementById("search");
    const filterSelect = document.getElementById("filter");
    const pagination = document.getElementById("pagination");
    const projectPanel = document.getElementById("projectPanel");
    const projectOverlay = document.getElementById("projectOverlay");

    // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¯Ø± localStorage
    function getProjects() {
      return JSON.parse(localStorage.getItem("isoProjects") || "[]");
    }

    function saveProjects(projects) {
      localStorage.setItem("isoProjects", JSON.stringify(projects));
    }

    function getFavorites() {
      return JSON.parse(localStorage.getItem("isoFavorites") || "[]");
    }

    // function toggleFavorites() {
    //   showFavoritesOnly = !showFavoritesOnly;
    //   currentPage = 1;

    //   // ØªØºÛŒÛŒØ± Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ø§Ø³ØªØ§ÛŒÙ„
    //   const favoritesIcon = document.getElementById("favoritesIcon");
    //   const starBtn = document.querySelector('.icon-btn[onclick="toggleFavorites()"]');

    //   if (showFavoritesOnly) {
    //     favoritesIcon.setAttribute("data-lucide", "star");
    //     starBtn.classList.add("active-favorite");
    //   } else {
    //     favoritesIcon.setAttribute("data-lucide", "star");
    //     starBtn.classList.remove("active-favorite");
    //   }

    //   lucide.createIcons();
    //   render();
    // }
    function toggleFavorite(code) {
      let favorites = getFavorites();
      if (favorites.includes(code)) {
        favorites = favorites.filter(c => c !== code);
      } else {
        favorites.push(code);
      }
      localStorage.setItem("isoFavorites", JSON.stringify(favorites));
      render();
    }

    function toggleFavorites() {
      showFavoritesOnly = !showFavoritesOnly;
      currentPage = 1;
      render();
    }


    function getStatuses() {
      return JSON.parse(localStorage.getItem("isoStatuses") || "{}");
    }

    function setStatus(code, status) {
      const statuses = getStatuses();
      statuses[code] = status;
      localStorage.setItem("isoStatuses", JSON.stringify(statuses));
      render();
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = i;
          render();
        };
        pagination.appendChild(btn);
      }
    }

    function render() {
      const search = searchInput.value.toLowerCase();
      const filter = filterSelect.value;
      const favorites = getFavorites();

      const filtered = data.filter(item => {
        const matchesSearch = item.code.toLowerCase().includes(search) || item.desc.includes(search);
        const matchesFilter = filter === "all" || item.category === filter;
        const isFavorite = favorites.includes(item.code);
        return matchesSearch && matchesFilter && (!showFavoritesOnly || isFavorite);
      });

      renderPagination(filtered.length);

      const paginatedItems = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
      container.innerHTML = "";
      paginatedItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "card";

        const statuses = getStatuses();
        const status = statuses[item.code];

        let statusHTML = "";
        if (status === "review") {
          statusHTML = `<div class="status-label status-review">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ</div>`;
        } else if (status === "expired") {
          statusHTML = `<div class="status-label status-expired">Ù…Ù†Ù‚Ø¶ÛŒâ€ŒØ´Ø¯Ù‡</div>`;
        }

        div.innerHTML = `
          <button class="favorite-btn" onclick="toggleFavorite('${item.code}')">
            <i data-lucide="${favorites.includes(item.code) ? 'star' : 'star-off'}"></i>
          </button>
          ${statusHTML}
          <div class="title">${item.code}</div>
          <div class="desc">${item.desc}</div>
          <div class="details">
            ${item.details}<br>
            <a href="${item.link}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª</a>
            <div style="margin-top:10px;">
              <label style="font-size: 13px;">ÙˆØ¶Ø¹ÛŒØª:</label>
              <select onchange="setStatus('${item.code}', this.value)">
                <option value="">---</option>
                <option value="review" ${status === "review" ? "selected" : ""}>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ</option>
                <option value="expired" ${status === "expired" ? "selected" : ""}>Ù…Ù†Ù‚Ø¶ÛŒâ€ŒØ´Ø¯Ù‡</option>
              </select>
            </div>
          </div>
        `;

        div.addEventListener("click", e => {
          if (!e.target.closest("button") && !e.target.closest("select")) {
            div.classList.toggle("open");
          }
        });
        container.appendChild(div);
      });

      lucide.createIcons();
    }

    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle("dark");
      const icon = document.getElementById("themeIcon");
      if (body.classList.contains("dark")) {
        icon.setAttribute("data-lucide", "sun");
      } else {
        icon.setAttribute("data-lucide", "moon");
      }
      lucide.createIcons();
      localStorage.setItem("iso-theme", body.classList.contains("dark") ? "dark" : "light");
    }

    function updateDate() {
      const now = new Date();
      const dayNames = ["ÛŒÚ©Ø´Ù†Ø¨Ù‡", "Ø¯ÙˆØ´Ù†Ø¨Ù‡", "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡", "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡", "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡", "Ø¬Ù…Ø¹Ù‡", "Ø´Ù†Ø¨Ù‡"];
      const day = dayNames[now.getDay()];
      const date = now.toLocaleDateString("fa-IR");
      const time = now.toLocaleTimeString("fa-IR");
      document.getElementById("liveDate").textContent = `${day} - ${date} - ${time}`;
    }

    setInterval(updateDate, 1000);
    updateDate();

    if (localStorage.getItem("iso-theme") === "dark") {
      document.body.classList.add("dark");
    }

    searchInput.addEventListener("input", () => { currentPage = 1; render(); });
    filterSelect.addEventListener("change", () => { currentPage = 1; render(); });

    lucide.createIcons();
    render();

    function toggleDashboard() {
      const panel = document.getElementById("dashboardPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
      updateDashboard();
    }

    function updateDashboard() {
      document.getElementById("totalCount").textContent = data.length;
      document.getElementById("favCount").textContent = getFavorites().length;
      document.getElementById("searchTerm").textContent = document.getElementById("search").value || '---';
      const filter = document.getElementById("filter").value;
      document.getElementById("activeFilter").textContent = filter === 'all' ? 'Ù‡Ù…Ù‡' : filter;
      document.getElementById("currentPageInfo").textContent = currentPage;
    }

    function downloadPDF() {
      const search = searchInput.value.toLowerCase();
      const filter = filterSelect.value;
      const favorites = getFavorites();

      // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      const filtered = data.filter(item => {
        const matchesSearch = item.code.toLowerCase().includes(search) || item.desc.includes(search);
        const matchesFilter = filter === "all" || item.category === filter;
        const isFavorite = !showFavoritesOnly || favorites.includes(item.code);
        return matchesSearch && matchesFilter && isFavorite;
      });

      // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø§Ù„Ù…Ø§Ù† Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ PDF
      const pdfContainer = document.createElement("div");
      pdfContainer.style.direction = "rtl";
      pdfContainer.style.fontFamily = "'Vazir', sans-serif";

      // ØªÙ‚Ø³ÛŒÙ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙØ­Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ 20 Ø¢ÛŒØªÙ… Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡)
      const itemsPerPage = 20;
      const pages = [];

      for (let i = 0; i < filtered.length; i += itemsPerPage) {
        const page = document.createElement("div");
        page.setAttribute("aria-label", `pdf-page-${pages.length}`);
        page.style.padding = "20px";

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡
        const title = document.createElement("h1");
        title.textContent = `Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ - ØµÙØ­Ù‡ ${pages.length + 1}`;
        title.style.textAlign = "center";
        title.style.color = "#1565c0";
        page.appendChild(title);

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ØµÙØ­Ù‡
        const pageItems = filtered.slice(i, i + itemsPerPage);
        pageItems.forEach(item => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.margin = "10px 0";
          div.style.padding = "10px";
          div.innerHTML = `
        <strong>${item.code}</strong><br>
        ${item.desc}<br>
        ${item.details}<br>
        <a href="${item.link}">${item.link}</a>
      `;
          page.appendChild(div);
        });

        pdfContainer.appendChild(page);
        pages.push(page);
      }

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¨Ù‡ ØµÙØ­Ù‡ (Ù…ÙˆÙ‚ØªØ§Ù‹)
      document.body.appendChild(pdfContainer);

      // ØªÙ†Ø¸ÛŒÙ…Ø§Øª PDF
      const pdfOptions = {
        margin: 10,
        filename: 'iso-standards.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          letterRendering: true
        },
        jsPDF: {
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait'
        }
      };

      // Ø§ÛŒØ¬Ø§Ø¯ PDF Ø¨Ø§ ØµÙØ­Ø§Øª Ù…ØªØ¹Ø¯Ø¯
      let worker = html2pdf()
        .set(pdfOptions)
        .from(pages[0]);

      worker = worker.toPdf(); // worker is now a jsPDF instance

      if (pages.length > 1) {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø± ØµÙØ­Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
        pages.slice(1).forEach((page, index) => {
          worker = worker
            .get('pdf')
            .then(pdf => {
              pdf.addPage(); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¬Ø¯ÛŒØ¯
            })
            .from(page)
            .toContainer()
            .toCanvas()
            .toPdf();
        });
      }

      // Ø°Ø®ÛŒØ±Ù‡ PDF Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
      worker.save().then(() => {
        document.body.removeChild(pdfContainer);
      });
    }

    // Upload System 
    document.getElementById("uploadTxt").addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const lines = content.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

        const matched = [];
        const unmatched = [];

        lines.forEach(codeLine => {
          const found = data.find(item => item.code.toLowerCase() === codeLine.toLowerCase());
          if (found) {
            matched.push(found);
          } else {
            unmatched.push(codeLine);
          }
        });

        displayMatchResults(matched, unmatched);
      };
      reader.readAsText(file);
    }

    function displayMatchResults(matched, unmatched) {
      const resultDiv = document.createElement("div");
      resultDiv.id = "matchResult";

      let html = `<h3>ğŸ“„ Ù†ØªÛŒØ¬Ù‡ ØªØ·Ø¨ÛŒÙ‚ ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡</h3>`;

      if (matched.length) {
        html += `<h4>âœ… Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</h4><ul>`;
        matched.forEach(item => {
          html += `<li><strong>${item.code}</strong> â€“ <a href="${item.link}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª</a></li>`;
        });
        html += `</ul>`;
      }

      if (unmatched.length) {
        html += `<h4>âŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ ÛŒØ§ÙØªâ€ŒÙ†Ø´Ø¯Ù‡:</h4><ul>`;
        unmatched.forEach(code => {
          html += `<li>${code}</li>`;
        });
        html += `</ul>`;
      }

      resultDiv.innerHTML = html;

      const oldResult = document.getElementById("matchResult");
      if (oldResult) oldResult.remove();

      container.prepend(resultDiv);
      lucide.createIcons();
    }

    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
    function openProjectPanel() {
      projectPanel.classList.add("open");
      projectOverlay.classList.add("active");
      loadProjects();
    }

    function closeProjectPanel() {
      projectPanel.classList.remove("open");
      projectOverlay.classList.remove("active");
      resetProjectForm();
    }

    function resetProjectForm() {
      document.getElementById("projectFormContainer").style.display = "block";
      document.getElementById("projectDetailsContainer").style.display = "none";
      document.getElementById("projectName").value = "";
      document.getElementById("projectNumber").value = "";
      document.getElementById("projectDescription").value = "";
      currentProject = null;
    }

    function showNewProjectForm() {
      resetProjectForm();
      document.getElementById("projectFormContainer").style.display = "block";
    }

    function saveProject() {
      const name = document.getElementById("projectName").value.trim();
      const number = document.getElementById("projectNumber").value.trim();
      const description = document.getElementById("projectDescription").value.trim();

      if (!name || !number) {
        alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        return;
      }

      const projects = getProjects();

      if (currentProject) {
        // ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÙˆØ¬ÙˆØ¯
        const projectIndex = projects.findIndex(p => p.id === currentProject.id);
        if (projectIndex !== -1) {
          projects[projectIndex].name = name;
          projects[projectIndex].number = number;
          projects[projectIndex].description = description;
        }
      } else {
        // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
        const newProject = {
          id: Date.now(),
          name,
          number,
          description,
          standards: []
        };
        projects.push(newProject);
        currentProject = newProject;
      }

      saveProjects(projects);
      loadProjects();
      loadProjectDetails(currentProject.id);
    }

    function loadProjects() {
      const projects = getProjects();
      const projectsList = document.getElementById("projectsList");
      projectsList.innerHTML = "";

      if (projects.length === 0) {
        document.getElementById("projectFormContainer").style.display = "block";
        document.getElementById("projectDetailsContainer").style.display = "none";
        return;
      }

      document.getElementById("projectFormContainer").style.display = "none";
      document.getElementById("projectDetailsContainer").style.display = "block";

      projects.forEach(project => {
        const projectItem = document.createElement("div");
        projectItem.className = "phase-item";
        projectItem.innerHTML = `
      <div class="phase-actions">
        <button class="btn btn-primary" onclick="editProject(${project.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger" onclick="deleteProject(${project.id})">Ø­Ø°Ù</button>
      </div>
      <div class="phase-title">${project.name} (${project.number})</div>
    `;

        projectItem.addEventListener("click", () => {
          loadProjectDetails(project.id);
        });

        projectsList.appendChild(projectItem);
      });

      // Ø§Ú¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
      if (projects.length > 0 && !currentProject) {
        loadProjectDetails(projects[0].id);
      }
    }

    function editProject(projectId) {
      event.stopPropagation();
      const projects = getProjects();
      const project = projects.find(p => p.id === projectId);

      if (!project) return;

      currentProject = project;
      document.getElementById("projectName").value = project.name;
      document.getElementById("projectNumber").value = project.number;
      document.getElementById("projectDescription").value = project.description;
      document.getElementById("projectFormContainer").style.display = "block";
    }

    function deleteProject(projectId) {
      event.stopPropagation();
      if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;

      const projects = getProjects();
      const updatedProjects = projects.filter(p => p.id !== projectId);

      saveProjects(updatedProjects);
      currentProject = null;
      loadProjects();
    }

    function loadProjectDetails(projectId) {
      const projects = getProjects();
      currentProject = projects.find(p => p.id === projectId);

      if (!currentProject) return;

      document.getElementById("currentProjectTitle").textContent = `${currentProject.name} (${currentProject.number})`;
      document.getElementById("currentProjectDescription").textContent = currentProject.description;
      renderStandards();
    }

    function renderStandards() {
      const standardsList = document.getElementById("standardsList");
      standardsList.innerHTML = "";

      if (!currentProject || !currentProject.standards || currentProject.standards.length === 0) {
        standardsList.innerHTML = "<p>Ù‡Ù†ÙˆØ² Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>";
        return;
      }

      currentProject.standards.forEach(standardCode => {
        const standard = data.find(item => item.code === standardCode);
        if (standard) {
          const standardItem = document.createElement("div");
          standardItem.className = "standard-item";
          standardItem.innerHTML = `
        <span>${standard.code} - ${standard.desc}</span>
        <button class="btn btn-danger" onclick="removeStandard('${standard.code}')">Ø­Ø°Ù</button>
      `;
          standardsList.appendChild(standardItem);
        }
      });
    }

    function searchStandard() {
      const searchTerm = document.getElementById("standardSearch").value.trim().toLowerCase();
      if (!searchTerm) return;

      const results = data.filter(item =>
        item.code.toLowerCase().includes(searchTerm) ||
        item.desc.toLowerCase().includes(searchTerm)
      ).slice(0, 5);

      const searchResultsList = document.getElementById("searchResultsList");
      searchResultsList.innerHTML = "";

      if (results.length === 0) {
        searchResultsList.innerHTML = "<p>Ù‡ÛŒÚ† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>";
      } else {
        results.forEach(item => {
          const resultItem = document.createElement("div");
          resultItem.className = "standard-item";
          resultItem.innerHTML = `
        <span>${item.code} - ${item.desc}</span>
        <button class="btn btn-primary" onclick="addStandard('${item.code}')">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
      `;
          searchResultsList.appendChild(resultItem);
        });
      }

      document.getElementById("searchResults").style.display = "block";
    }

    function addStandard(standardCode) {
      if (!currentProject) return;

      const projects = getProjects();
      const projectIndex = projects.findIndex(p => p.id === currentProject.id);

      if (projectIndex === -1) return;

      if (!projects[projectIndex].standards.includes(standardCode)) {
        projects[projectIndex].standards.push(standardCode);
        saveProjects(projects);
        currentProject = projects[projectIndex];
        renderStandards();
      }

      document.getElementById("standardSearch").value = "";
      document.getElementById("searchResults").style.display = "none";
    }

    function removeStandard(standardCode) {
      if (!currentProject) return;

      const projects = getProjects();
      const projectIndex = projects.findIndex(p => p.id === currentProject.id);

      if (projectIndex === -1) return;

      projects[projectIndex].standards =
        projects[projectIndex].standards.filter(code => code !== standardCode);

      saveProjects(projects);
      currentProject = projects[projectIndex];
      renderStandards();
    }

    function exportToExcel() {
      if (!currentProject) return;

      let csvContent = "Ú©Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯,Ø¹Ù†ÙˆØ§Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯,ØªÙˆØ¶ÛŒØ­Ø§Øª,Ù„ÛŒÙ†Ú©\n";

      currentProject.standards.forEach(standardCode => {
        const standard = data.find(item => item.code === standardCode);
        if (standard) {
          csvContent += `"${standard.code}","${standard.desc}","${standard.details}","${standard.link}"\n`;
        }
      });

      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ_${currentProject.name}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    function exportToPDF(projectId) {
      var project = currentProject;
      // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ PDF
      const pdfContainer = document.createElement("div");
      pdfContainer.style.direction = "rtl";
      pdfContainer.style.fontFamily = "'Vazir', sans-serif";
      pdfContainer.style.padding = "20px";

      // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø¯Ø± Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
      const header = document.createElement("div");
      header.style.background = "linear-gradient(135deg, #1565c0, #2196f3)";
      header.style.color = "white";
      header.style.padding = "25px";
      header.style.borderRadius = "10px";
      header.style.marginBottom = "25px";
      header.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
      header.style.textAlign = "center";

      header.innerHTML = `
    <h1 style="margin: 0; font-size: 28px; font-weight: 600;">${project.name}</h1>
    <h2 style="margin: 8px 0 0; font-size: 20px; font-weight: 400;">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡: ${project.number}</h2>
    ${project.description ? `<p style="margin: 15px 0 0; font-size: 16px; line-height: 1.6;">${project.description}</p>` : ''}
  `;

      pdfContainer.appendChild(header);

      // Ø¨Ø®Ø´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
      const standardsSection = document.createElement("div");
      standardsSection.style.marginTop = "30px";

      const standardsTitle = document.createElement("h2");
      standardsTitle.textContent = "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·";
      standardsTitle.style.color = "#1565c0";
      standardsTitle.style.borderBottom = "2px solid #1565c0";
      standardsTitle.style.paddingBottom = "8px";
      standardsTitle.style.fontSize = "22px";
      standardsSection.appendChild(standardsTitle);

      // Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§
      const standardsList = document.createElement("div");
      standardsList.style.marginTop = "15px";

      const standards = project.standards || [];
      if (standards.length === 0) {
        standardsList.innerHTML = `
      <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px; color: #666;">
        Ù‡ÛŒÚ† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
      </div>
    `;
      } else {
        standards.forEach(standardCode => {
          const standard = data.find(item => item.code === standardCode);
          if (standard) {
            const standardCard = document.createElement("div");
            standardCard.style.background = "white";
            standardCard.style.borderRadius = "8px";
            standardCard.style.padding = "15px";
            standardCard.style.margin = "15px 0";
            standardCard.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
            standardCard.style.borderLeft = "4px solid #2196f3";

            standardCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #1565c0; font-size: 18px;">${standard.code}</h3>
            <a href="${standard.link}" target="_blank" style="color: #2196f3; text-decoration: none; font-size: 14px;">
              Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
            </a>
          </div>
          <p style="margin: 10px 0 5px; font-weight: 500; color: #333;">${standard.desc}</p>
          <p style="margin: 5px 0 0; color: #555; font-size: 14px; line-height: 1.5;">${standard.details}</p>
        `;

            standardsList.appendChild(standardCard);
          }
        });
      }

      standardsSection.appendChild(standardsList);
      pdfContainer.appendChild(standardsSection);

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÙˆØªØ±
      const footer = document.createElement("div");
      footer.style.marginTop = "30px";
      footer.style.paddingTop = "15px";
      footer.style.borderTop = "1px solid #eee";
      footer.style.textAlign = "center";
      footer.style.color = "#666";
      footer.style.fontSize = "12px";

      const now = new Date();
      const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
      footer.textContent = `ØªØ§Ø±ÛŒØ® Ø®Ø±ÙˆØ¬ÛŒ: ${now.toLocaleDateString('fa-IR', dateOptions)}`;

      pdfContainer.appendChild(footer);

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¨Ù‡ ØµÙØ­Ù‡ (Ù…ÙˆÙ‚ØªØ§Ù‹)
      document.body.appendChild(pdfContainer);

      // ØªÙ†Ø¸ÛŒÙ…Ø§Øª PDF
      const pdfOptions = {
        margin: 15,
        filename: `Ø¬Ø²Ø¦ÛŒØ§Øª_Ù¾Ø±ÙˆÚ˜Ù‡_${project.name.replace(/\s+/g, '_')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          letterRendering: true,
          logging: true
        },
        jsPDF: {
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait'
        }
      };

      // Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ PDF
      html2pdf()
        .set(pdfOptions)
        .from(pdfContainer)
        .save()
        .then(() => {
          document.body.removeChild(pdfContainer);
        });
    }
    function exportToPDF() {
      if (!currentProject) return;

      const tempDiv = document.createElement("div");
      tempDiv.style.direction = "rtl";
      tempDiv.style.fontFamily = "'Vazir', sans-serif";
      console.log(currentProject);
      tempDiv.innerHTML = `
    <center style="font-weight: bold; color: blue">Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ${currentProject.name} </center>
    <center>${currentProject.description}</center>
    <table border="1" cellpadding="5" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>Ú©Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</th>
          <th>Ø¹Ù†ÙˆØ§Ù†</th>
          <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        
        ${currentProject.standards.map(standardCode => {
        const standard = data.find(item => item.code === standardCode);
        return standard ? `
            <tr>
              <td>${standard.code}</td>
              <td>${standard.desc}</td>
              <td>${standard.details}</td>
            </tr>
          ` : "";
      }).join("")}
      </tbody>
    </table>
  `;

      const opt = {
        margin: 0.5,
        filename: `Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ_${currentProject.name}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(tempDiv).save();
    }
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      pagination.innerHTML = "";

      // ØªØ¹ÛŒÛŒÙ† Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´
      const maxVisiblePages = 5; // ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§ØªÛŒ Ú©Ù‡ Ø¯Ø± Ù‡Ø± Ù„Ø­Ø¸Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
      let startPage, endPage;

      if (totalPages <= maxVisiblePages) {
        // Ø§Ú¯Ø± ØµÙØ­Ø§Øª Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø´Ù†Ø¯
        startPage = 1;
        endPage = totalPages;
      } else {
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
        const half = Math.floor(maxVisiblePages / 2);
        if (currentPage <= half + 1) {
          startPage = 1;
          endPage = maxVisiblePages;
        } else if (currentPage >= totalPages - half) {
          startPage = totalPages - maxVisiblePages + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - half;
          endPage = currentPage + half;
        }
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Previous Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯
      if (currentPage > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.innerHTML = "&laquo; Ù‚Ø¨Ù„ÛŒ";
        prevBtn.onclick = () => {
          currentPage--;
          render();
        };
        pagination.appendChild(prevBtn);
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ø§Øª
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) {
          btn.classList.add("active");
          btn.disabled = true;
        }
        btn.onclick = () => {
          currentPage = i;
          render();
        };
        pagination.appendChild(btn);
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Next Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯
      if (currentPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.innerHTML = "Ø¨Ø¹Ø¯ÛŒ &raquo;";
        nextBtn.onclick = () => {
          currentPage++;
          render();
        };
        pagination.appendChild(nextBtn);
      }
    }
  </script>
</body>

</html>