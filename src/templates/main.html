<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø±Ø¬Ø¹ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‡Ø§</title>
    <script>
        let data = []; // This will hold our standards data
        let isInitialized = false;
        let isAdminLoggedIn = false;

        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/user/profile', {
                    credentials: 'include'
                });
                const userData = await response.json();
                isAdminLoggedIn = userData.is_admin; // ÙØ±Ø¶ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø³Ø±ÙˆØ± ÙÛŒÙ„Ø¯ is_admin Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                return isAdminLoggedIn;
            } catch (error) {
                isAdminLoggedIn = false;
                return false;
            }
        }

        async function initializeApp() {
            if (isInitialized) return;
            isInitialized = true;

            try {
                // Check authentication
                const authResponse = await fetch('/api/user/profile', {
                    credentials: 'include'
                });

                if (!authResponse.ok) {
                    window.location.href = '/login/';
                    return;
                }

                // Load standards data
                await loadStandards();

                // Initialize the rest of your app
                initApp();
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/login/';
            }
        }

        async function loadStandards() {
            try {
                const response = await fetch('/api/standards/', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load standards');
                }

                data = await response.json();

                // Load categories for filter dropdown
                await loadCategories();
            } catch (error) {
                console.error('Error loading standards:', error);
                // Fallback to empty data if API fails
                data = [];
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories/', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load categories');
                }

                const categories = await response.json();
                const filterSelect = document.getElementById('filter');

                // Clear existing options except the first one
                while (filterSelect.options.length > 1) {
                    filterSelect.remove(1);
                }

                // Add new categories
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function initApp() {
            // Initialize theme
            if (localStorage.getItem("iso-theme") === "dark") {
                document.body.classList.add("dark");
            }

            // Initialize date display
            updateDate();
            setInterval(updateDate, 1000);

            // Initialize icons
            lucide.createIcons();

            // Initial render
            render();
        }

        // Modified to prevent multiple initializations
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            checkAdminStatus()
        });

        // Rest of your existing JavaScript functions...
    </script>

    <link href="../static/style.css" rel="stylesheet"/>
    <!-- <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">; -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js">

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
<h1 id="main_text">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø±Ø¬Ø¹ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‡Ø§</h1>

<footer>
    <div>BNP Developer Group</div>
    <div id="liveDate"></div>
    <div>1.1</div>
</footer>

<div class="controls">
    <input type="text" id="search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ...">
    <select id="filter">
        <option value="all">Ù‡Ù…Ù‡</option>
        <!-- Categories will be loaded dynamically -->
    </select>
    <button class="icon-btn" onclick="toggleDarkMode()" title="Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡/Ø±ÙˆØ´Ù†">
        <i id="themeIcon" data-lucide="moon"></i>
    </button>
    <button class="icon-btn" onclick="toggleDashboard()" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
        <i data-lucide="settings"></i>
    </button>
    <button class="icon-btn" onclick="downloadPDF()" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF">
        <i data-lucide="download"></i>
    </button>
    <label for="uploadTxt" class="icon-btn" title="Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ txt">
        <i data-lucide="file-plus"></i>
    </label>
    <input type="file" id="uploadTxt" accept=".txt" hidden/>
    <button class="icon-btn" onclick="openProjectPanel()" title="Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§">
        <i data-lucide="folder-plus"></i>
    </button>
    <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø³ØªØ§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯ -->
    <button class="icon-btn" onclick="toggleFavorites()" title="Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§">
        <i id="favoritesIcon" data-lucide="star"></i>
    </button>
    <!-- Ø³Ø§ÛŒØ± Ú©Ù†ØªØ±Ù„ Ù‡Ø§ ... -->
    <button class="icon-btn" onclick="openAdminPanel()" title="Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†">
        <i data-lucide="shield"></i>
    </button>
    <button class="icon-btn" onclick="openProfilePanel()" title="Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <i data-lucide="user"></i>
    </button>
</div>

<!-- <div class="favorites-toggle">
  <button onclick="toggleFavorites()">Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ø§Ù‚Ù‡â€Œ Ù…Ù†Ø¯ÛŒâ€Œ Ù‡Ø§</button>
</div> -->

<div id="container"></div>
<div class="pagination" id="pagination"></div>

<div class="dashboard-panel" id="dashboardPanel">
    <h3>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h3>
    <ul>
        <li>ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§: <span id="totalCount">0</span></li>
        <li>â­ Ø¹Ù„Ø§Ù‚Ù‡â€Œ Ù…Ù†Ø¯ÛŒâ€Œ Ù‡Ø§: <span id="favCount">0</span></li>
        <li>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ¹Ù„ÛŒ: <span id="searchTerm">---</span></li>
        <li>ğŸ—‚ Ø¯Ø³ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨â€Œ Ø´Ø¯Ù‡: <span id="activeFilter">Ù‡Ù…Ù‡</span></li>
        <li>ğŸ“„ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ: <span id="currentPageInfo">1</span></li>
        <li>
            <button onclick="toggleDashboard()"
                    style="margin-top:10px;background:#f44336;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;width:100%">
                Ø¨Ø³ØªÙ†
            </button>
        </li>
    </ul>
</div>

<!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ -->
<!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ -->
<div class="overlay" id="projectOverlay"></div>
<div class="project-panel" id="projectPanel">
    <div class="project-panel-header">
        <h3 class="project-panel-title">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h3>
        <button class="close-panel" onclick="closeProjectPanel()">&times;</button>
    </div>

    <div id="projectFormContainer">
        <div class="form-group">
            <label for="projectName">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <input type="text" id="projectName" class="form-control" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="form-group">
            <label for="projectNumber">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <input type="text" id="projectNumber" class="form-control" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="form-group">
            <label for="projectDescription">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea id="projectDescription" class="form-control" rows="3"
                      placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± Û· Ø®Ø·)"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveProject()">Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    </div>

    <div id="projectDetailsContainer" style="display: none;">
        <div class="projects-list" id="projectsList">
            <!-- Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <button class="btn btn-primary" onclick="showNewProjectForm()" style="margin-top: 20px;">Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</button>

        <div id="standardsContainer" style="margin-top: 30px;">
            <h4 id="currentProjectTitle"></h4>
            <p id="currentProjectDescription"></p>

            <div class="add-standard-form">
                <input type="text" id="standardSearch" class="form-control" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯...">
                <button class="btn btn-primary" onclick="searchStandard()">Ø¬Ø³ØªØ¬Ùˆ</button>
            </div>

            <div id="searchResults" style="margin-top: 15px; display: none;">
                <h6>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h6>
                <div id="searchResultsList"></div>
            </div>

            <div class="standards-list" id="standardsList" style="margin-top: 20px;">
                <!-- Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>

            <div class="export-options" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="exportToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
                <button class="btn btn-secondary" onclick="exportToPDF()">Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
            </div>
        </div>
    </div>
</div>
<!-- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† -->
<div class="overlay" id="adminOverlay"></div>
<div class="project-panel" id="adminPanel">
    <div class="project-panel-header">
        <h3 class="project-panel-title" id="adminPanelTitle">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†</h3>
        <button class="close-panel" onclick="closeAdminPanel()">&times;</button>
    </div>


    <div id="adminMenuContainer" style="display: none;">
        <ul class="admin-menu">
            <li>
                <button class="btn btn-primary" onclick="showAdminSection('manageStandards')">
                    <i data-lucide="file-text"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§
                </button>
            </li>
            <li>
                <button class="btn btn-danger" onclick="adminLogout()">
                    <i data-lucide="log-out"></i> Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…
                </button>
            </li>
        </ul>
    </div>

    <div id="manageStandardsContainer" style="display: none;">
        <h4>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§</h4>

        <!-- Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† -->
        <div class="admin-controls">
            <input type="text" id="adminStandardSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯..." class="form-control">
            <button class="btn btn-primary" onclick="searchAdminStandards()">Ø¬Ø³ØªØ¬Ùˆ</button>
            <button class="btn btn-success" onclick="showAddStandardForm()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</button>
        </div>

        <!-- Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ -->
        <div id="adminStandardsList" class="standards-list" style="margin-top: 20px;"></div>

        <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ -->
        <div id="editStandardContainer" style="display: none; margin-top: 20px;">
            <div class="form-group">
                <label>Ú©Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</label>
                <input type="text" id="editCode" class="form-control">
            </div>
            <div class="form-group">
                <label>Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="editDesc" class="form-control">
            </div>
            <div class="form-group">
                <label>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                <!-- ØªØºÛŒÛŒØ± Ø§Ø² input Ø¨Ù‡ select -->
                <select id="editCategory" class="form-control">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
                    <!-- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </select>
            </div>
            <div class="form-group">
                <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                <textarea id="editDetails" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Ù„ÛŒÙ†Ú©</label>
                <input type="text" id="editLink" class="form-control">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveEditedStandard()">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-secondary" onclick="cancelEditStandard()">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- Ù¾Ù†Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ -->
<div class="overlay" id="profileOverlay"></div>
<div class="project-panel" id="profilePanel">
    <div class="project-panel-header">
        <h3 class="project-panel-title">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
        <button class="close-panel" onclick="closeProfilePanel()">&times;</button>
    </div>

    <div id="profileInfo">
        <div class="profile-avatar">
            <i data-lucide="user" style="width: 80px; height: 80px;"></i>
        </div>
        <div class="profile-details">
            <h4 id="profileUsername"></h4>
            <p id="profileEmail"></p>
            <p id="profileFullName"></p>
            <p id="profileJoinDate"></p>
        </div>

        <div class="profile-actions">
            <button class="btn btn-primary" onclick="showChangePasswordForm()">
                <i data-lucide="key"></i> ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
            </button>
            <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;">
                <i data-lucide="log-out"></i> Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨
            </button>
        </div>
    </div>

    <div id="changePasswordForm" style="display: none;">
        <h4>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h4>
        <div class="form-group">
            <label for="currentPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ</label>
            <input type="password" id="currentPassword" class="form-control">
        </div>
        <div class="form-group">
            <label for="newPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯</label>
            <input type="password" id="newPassword" class="form-control">
        </div>
        <div class="form-group">
            <label for="confirmPassword">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯</label>
            <input type="password" id="confirmPassword" class="form-control">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="changePassword()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            <button class="btn btn-secondary" onclick="cancelChangePassword()">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<script>
    const itemsPerPage = 15;
    let currentPage = 1;
    let showFavoritesOnly = false;
    let currentProject = null;
    let currentPhase = null;

    const container = document.getElementById("container");
    const searchInput = document.getElementById("search");
    const filterSelect = document.getElementById("filter");
    const pagination = document.getElementById("pagination");
    const projectPanel = document.getElementById("projectPanel");
    const projectOverlay = document.getElementById("projectOverlay");

    // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¯Ø± localStorage
    function getProjects() {
        return JSON.parse(localStorage.getItem("isoProjects") || "[]");
    }

    function saveProjects(projects) {
        localStorage.setItem("isoProjects", JSON.stringify(projects));
    }

    function getFavorites() {
        return JSON.parse(localStorage.getItem("isoFavorites") || "[]");
    }

    // function toggleFavorites() {
    //   showFavoritesOnly = !showFavoritesOnly;
    //   currentPage = 1;

    //   // ØªØºÛŒÛŒØ± Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ø§Ø³ØªØ§ÛŒÙ„
    //   const favoritesIcon = document.getElementById("favoritesIcon");
    //   const starBtn = document.querySelector('.icon-btn[onclick="toggleFavorites()"]');

    //   if (showFavoritesOnly) {
    //     favoritesIcon.setAttribute("data-lucide", "star");
    //     starBtn.classList.add("active-favorite");
    //   } else {
    //     favoritesIcon.setAttribute("data-lucide", "star");
    //     starBtn.classList.remove("active-favorite");
    //   }

    //   lucide.createIcons();
    //   render();
    // }
    function toggleFavorite(code) {
        let favorites = getFavorites();
        if (favorites.includes(code)) {
            favorites = favorites.filter(c => c !== code);
        } else {
            favorites.push(code);
        }
        localStorage.setItem("isoFavorites", JSON.stringify(favorites));
        render();
    }

    function toggleFavorites() {
        showFavoritesOnly = !showFavoritesOnly;
        currentPage = 1;
        render();
    }


    function getStatuses() {
        return JSON.parse(localStorage.getItem("isoStatuses") || "{}");
    }

    async function setStatus(code, newStatus) {
        try {
            const standard = data.find(item => item.code === code);
            if (!standard) return;

            const response = await fetch(`/api/standards/${standard.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({status: newStatus})
            });

            if (response.ok) {
                standard.status = newStatus;
                render(); // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª UI
            }
        } catch (error) {
            console.error('Error:', error);
            const select = document.querySelector(`select[data-code="${code}"]`);
            if (select) select.value = standard.status;
        }
    }

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pagination.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            if (i === currentPage) btn.classList.add("active");
            btn.onclick = () => {
                currentPage = i;
                render();
            };
            pagination.appendChild(btn);
        }
    }

    function render() {
        const search = searchInput.value.toLowerCase();
        const filter = filterSelect.value;
        const favorites = getFavorites();

        const filtered = data.filter(item => {
            const matchesSearch = item.code.toLowerCase().includes(search) || item.desc.includes(search);
            const matchesFilter = filter === "all" || item.category === filter;
            const isFavorite = favorites.includes(item.code);
            return matchesSearch && matchesFilter && (!showFavoritesOnly || isFavorite);
        });

        renderPagination(filtered.length);

        const paginatedItems = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
        container.innerHTML = "";
        paginatedItems.forEach(item => {
            const div = document.createElement("div");
            div.className = "card";

            // Ø¨Ø®Ø´ ÙˆØ¶Ø¹ÛŒØª (Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            const item_status = item.status === "normal"?"Ø¹Ø§Ø¯ÛŒ":item.status === "review"?"Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ":"Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡"
            const statusLabel = `
            <div class="status-display" style="margin-top:10px;">
                <span style="font-size: 13px;">ÙˆØ¶Ø¹ÛŒØª: </span>
                <span class="status-text">${item_status}</span>
            </div>
        `;

            // Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ¶Ø¹ÛŒØª (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†)
            const statusSelector = isAdminLoggedIn ? `
            <div class="status-control" style="margin-top:10px;">
                <select
                    data-code="${item.code}"
                    onchange="setStatus('${item.code}', this.value)"
                    class="status-select"
                >
                    <option value="normal" ${item.status === 'normal' ? 'selected' : ''}>Ø¹Ø§Ø¯ÛŒ</option>
                    <option value="review" ${item.status === 'review' ? 'selected' : ''}>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ</option>
                    <option value="expired" ${item.status === 'expired' ? 'selected' : ''}>Ù…Ù†Ù‚Ø¶ÛŒâ€ŒØ´Ø¯Ù‡</option>
                </select>
            </div>
        ` : '';

            div.innerHTML = `
            <button class="favorite-btn" onclick="toggleFavorite('${item.code}')">
                <i data-lucide="${favorites.includes(item.code) ? 'star' : 'star-off'}"></i>
            </button>
            <div class="title">${item.code}</div>
            ${statusLabel}
            <div class="desc">${item.desc}</div>
            <div class="details">
                ${item.details}<br>
                <a href="${item.link}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª</a>
                ${statusSelector}
            </div>
        `;

            div.addEventListener("click", e => {
                if (!e.target.closest("button") && !e.target.closest("select")) {
                    div.classList.toggle("open");
                }
            });
            container.appendChild(div);
        });

        lucide.createIcons();
    }

    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle("dark");
        const icon = document.getElementById("themeIcon");
        if (body.classList.contains("dark")) {
            icon.setAttribute("data-lucide", "sun");
        } else {
            icon.setAttribute("data-lucide", "moon");
        }
        lucide.createIcons();
        localStorage.setItem("iso-theme", body.classList.contains("dark") ? "dark" : "light");
    }

    function updateDate() {
        const now = new Date();
        const dayNames = ["ÛŒÚ©Ø´Ù†Ø¨Ù‡", "Ø¯ÙˆØ´Ù†Ø¨Ù‡", "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡", "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡", "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡", "Ø¬Ù…Ø¹Ù‡", "Ø´Ù†Ø¨Ù‡"];
        const day = dayNames[now.getDay()];
        const date = now.toLocaleDateString("fa-IR");
        const time = now.toLocaleTimeString("fa-IR");
        document.getElementById("liveDate").textContent = `${day} - ${date} - ${time}`;
    }

    setInterval(updateDate, 1000);
    updateDate();

    if (localStorage.getItem("iso-theme") === "dark") {
        document.body.classList.add("dark");
    }

    searchInput.addEventListener("input", () => {
        currentPage = 1;
        render();
    });
    filterSelect.addEventListener("change", () => {
        currentPage = 1;
        render();
    });

    lucide.createIcons();
    render();

    function toggleDashboard() {
        const panel = document.getElementById("dashboardPanel");
        panel.style.display = panel.style.display === "block" ? "none" : "block";
        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById("totalCount").textContent = data.length;
        document.getElementById("favCount").textContent = getFavorites().length;
        document.getElementById("searchTerm").textContent = document.getElementById("search").value || '---';
        const filter = document.getElementById("filter").value;
        document.getElementById("activeFilter").textContent = filter === 'all' ? 'Ù‡Ù…Ù‡' : filter;
        document.getElementById("currentPageInfo").textContent = currentPage;
    }

    function downloadPDF() {
        const search = searchInput.value.toLowerCase();
        const filter = filterSelect.value;
        const favorites = getFavorites();

        // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const filtered = data.filter(item => {
            const matchesSearch = item.code.toLowerCase().includes(search) || item.desc.includes(search);
            const matchesFilter = filter === "all" || item.category === filter;
            const isFavorite = !showFavoritesOnly || favorites.includes(item.code);
            return matchesSearch && matchesFilter && isFavorite;
        });

        // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø§Ù„Ù…Ø§Ù† Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ PDF
        const pdfContainer = document.createElement("div");
        pdfContainer.style.direction = "rtl";
        pdfContainer.style.fontFamily = "'Vazir', sans-serif";

        // ØªÙ‚Ø³ÛŒÙ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙØ­Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ 20 Ø¢ÛŒØªÙ… Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡)
        const itemsPerPage = 20;
        const pages = [];

        for (let i = 0; i < filtered.length; i += itemsPerPage) {
            const page = document.createElement("div");
            page.setAttribute("aria-label", `pdf-page-${pages.length}`);
            page.style.padding = "20px";

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡
            const title = document.createElement("h1");
            title.textContent = `Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ - ØµÙØ­Ù‡ ${pages.length + 1}`;
            title.style.textAlign = "center";
            title.style.color = "#1565c0";
            page.appendChild(title);

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ØµÙØ­Ù‡
            const pageItems = filtered.slice(i, i + itemsPerPage);
            pageItems.forEach(item => {
                const div = document.createElement("div");
                div.style.border = "1px solid #ccc";
                div.style.margin = "10px 0";
                div.style.padding = "10px";
                div.innerHTML = `
        <strong>${item.code}</strong><br>
        ${item.desc}<br>
        ${item.details}<br>
        <a href="${item.link}">${item.link}</a>
      `;
                page.appendChild(div);
            });

            pdfContainer.appendChild(page);
            pages.push(page);
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¨Ù‡ ØµÙØ­Ù‡ (Ù…ÙˆÙ‚ØªØ§Ù‹)
        document.body.appendChild(pdfContainer);

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª PDF
        const pdfOptions = {
            margin: 10,
            filename: 'iso-standards.pdf',
            image: {type: 'jpeg', quality: 0.98},
            html2canvas: {
                scale: 2,
                useCORS: true,
                letterRendering: true
            },
            jsPDF: {
                unit: 'mm',
                format: 'a4',
                orientation: 'portrait'
            }
        };

        // Ø§ÛŒØ¬Ø§Ø¯ PDF Ø¨Ø§ ØµÙØ­Ø§Øª Ù…ØªØ¹Ø¯Ø¯
        let worker = html2pdf()
            .set(pdfOptions)
            .from(pages[0]);

        worker = worker.toPdf(); // worker is now a jsPDF instance

        if (pages.length > 1) {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø± ØµÙØ­Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
            pages.slice(1).forEach((page, index) => {
                worker = worker
                    .get('pdf')
                    .then(pdf => {
                        pdf.addPage(); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¬Ø¯ÛŒØ¯
                    })
                    .from(page)
                    .toContainer()
                    .toCanvas()
                    .toPdf();
            });
        }

        // Ø°Ø®ÛŒØ±Ù‡ PDF Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
        worker.save().then(() => {
            document.body.removeChild(pdfContainer);
        });
    }

    // Upload System 
    document.getElementById("uploadTxt").addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const content = e.target.result;
            const lines = content.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

            const matched = [];
            const unmatched = [];

            lines.forEach(codeLine => {
                const found = data.find(item => item.code.toLowerCase() === codeLine.toLowerCase());
                if (found) {
                    matched.push(found);
                } else {
                    unmatched.push(codeLine);
                }
            });

            displayMatchResults(matched, unmatched);
        };
        reader.readAsText(file);
    }

    function displayMatchResults(matched, unmatched) {
        const resultDiv = document.createElement("div");
        resultDiv.id = "matchResult";

        let html = `<h3>ğŸ“„ Ù†ØªÛŒØ¬Ù‡ ØªØ·Ø¨ÛŒÙ‚ ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡</h3>`;

        if (matched.length) {
            html += `<h4>âœ… Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</h4><ul>`;
            matched.forEach(item => {
                html += `<li><strong>${item.code}</strong> â€“ <a href="${item.link}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª</a></li>`;
            });
            html += `</ul>`;
        }

        if (unmatched.length) {
            html += `<h4>âŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ ÛŒØ§ÙØªâ€ŒÙ†Ø´Ø¯Ù‡:</h4><ul>`;
            unmatched.forEach(code => {
                html += `<li>${code}</li>`;
            });
            html += `</ul>`;
        }

        resultDiv.innerHTML = html;

        const oldResult = document.getElementById("matchResult");
        if (oldResult) oldResult.remove();

        container.prepend(resultDiv);
        lucide.createIcons();
    }

    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
    function openProjectPanel() {
        projectPanel.classList.add("open");
        projectOverlay.classList.add("active");
        loadProjects();
    }

    function closeProjectPanel() {
        projectPanel.classList.remove("open");
        projectOverlay.classList.remove("active");
        resetProjectForm();
    }

    function resetProjectForm() {
        document.getElementById("projectFormContainer").style.display = "block";
        document.getElementById("projectDetailsContainer").style.display = "none";
        document.getElementById("projectName").value = "";
        document.getElementById("projectNumber").value = "";
        document.getElementById("projectDescription").value = "";
        currentProject = null;
    }

    function showNewProjectForm() {
        resetProjectForm();
        document.getElementById("projectFormContainer").style.display = "block";
    }

    function saveProject() {
        const name = document.getElementById("projectName").value.trim();
        const number = document.getElementById("projectNumber").value.trim();
        const description = document.getElementById("projectDescription").value.trim();

        if (!name || !number) {
            alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            return;
        }

        const projects = getProjects();

        if (currentProject) {
            // ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÙˆØ¬ÙˆØ¯
            const projectIndex = projects.findIndex(p => p.id === currentProject.id);
            if (projectIndex !== -1) {
                projects[projectIndex].name = name;
                projects[projectIndex].number = number;
                projects[projectIndex].description = description;
            }
        } else {
            // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
            const newProject = {
                id: Date.now(),
                name,
                number,
                description,
                standards: []
            };
            projects.push(newProject);
            currentProject = newProject;
        }

        saveProjects(projects);
        loadProjects();
        loadProjectDetails(currentProject.id);
    }

    function loadProjects() {
        const projects = getProjects();
        const projectsList = document.getElementById("projectsList");
        projectsList.innerHTML = "";

        if (projects.length === 0) {
            document.getElementById("projectFormContainer").style.display = "block";
            document.getElementById("projectDetailsContainer").style.display = "none";
            return;
        }

        document.getElementById("projectFormContainer").style.display = "none";
        document.getElementById("projectDetailsContainer").style.display = "block";

        projects.forEach(project => {
            const projectItem = document.createElement("div");
            projectItem.className = "phase-item";
            projectItem.innerHTML = `
      <div class="phase-actions">
        <button class="btn btn-primary" onclick="editProject(${project.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger" onclick="deleteProject(${project.id})">Ø­Ø°Ù</button>
      </div>
      <div class="phase-title">${project.name} (${project.number})</div>
    `;

            projectItem.addEventListener("click", () => {
                loadProjectDetails(project.id);
            });

            projectsList.appendChild(projectItem);
        });

        // Ø§Ú¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (projects.length > 0 && !currentProject) {
            loadProjectDetails(projects[0].id);
        }
    }

    function editProject(projectId) {
        event.stopPropagation();
        const projects = getProjects();
        const project = projects.find(p => p.id === projectId);

        if (!project) return;

        currentProject = project;
        document.getElementById("projectName").value = project.name;
        document.getElementById("projectNumber").value = project.number;
        document.getElementById("projectDescription").value = project.description;
        document.getElementById("projectFormContainer").style.display = "block";
    }

    function deleteProject(projectId) {
        event.stopPropagation();
        if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;

        const projects = getProjects();
        const updatedProjects = projects.filter(p => p.id !== projectId);

        saveProjects(updatedProjects);
        currentProject = null;
        loadProjects();
    }

    function loadProjectDetails(projectId) {
        const projects = getProjects();
        currentProject = projects.find(p => p.id === projectId);

        if (!currentProject) return;

        document.getElementById("currentProjectTitle").textContent = `${currentProject.name} (${currentProject.number})`;
        document.getElementById("currentProjectDescription").textContent = currentProject.description;
        renderStandards();
    }

    function renderStandards() {
        const standardsList = document.getElementById("standardsList");
        standardsList.innerHTML = "";

        if (!currentProject || !currentProject.standards || currentProject.standards.length === 0) {
            standardsList.innerHTML = "<p>Ù‡Ù†ÙˆØ² Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>";
            return;
        }

        currentProject.standards.forEach(standardCode => {
            const standard = data.find(item => item.code === standardCode);
            if (standard) {
                const standardItem = document.createElement("div");
                standardItem.className = "standard-item";
                standardItem.innerHTML = `
        <span>${standard.code} - ${standard.desc}</span>
        <button class="btn btn-danger" onclick="removeStandard('${standard.code}')">Ø­Ø°Ù</button>
      `;
                standardsList.appendChild(standardItem);
            }
        });
    }

    function searchStandard() {
        const searchTerm = document.getElementById("standardSearch").value.trim().toLowerCase();
        if (!searchTerm) return;

        const results = data.filter(item =>
            item.code.toLowerCase().includes(searchTerm) ||
            item.desc.toLowerCase().includes(searchTerm)
        ).slice(0, 5);

        const searchResultsList = document.getElementById("searchResultsList");
        searchResultsList.innerHTML = "";

        if (results.length === 0) {
            searchResultsList.innerHTML = "<p>Ù‡ÛŒÚ† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>";
        } else {
            results.forEach(item => {
                const resultItem = document.createElement("div");
                resultItem.className = "standard-item";
                resultItem.innerHTML = `
        <span>${item.code} - ${item.desc}</span>
        <button class="btn btn-primary" onclick="addStandard('${item.code}')">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
      `;
                searchResultsList.appendChild(resultItem);
            });
        }

        document.getElementById("searchResults").style.display = "block";
    }

    function addStandard(standardCode) {
        if (!currentProject) return;

        const projects = getProjects();
        const projectIndex = projects.findIndex(p => p.id === currentProject.id);

        if (projectIndex === -1) return;

        if (!projects[projectIndex].standards.includes(standardCode)) {
            projects[projectIndex].standards.push(standardCode);
            saveProjects(projects);
            currentProject = projects[projectIndex];
            renderStandards();
        }

        document.getElementById("standardSearch").value = "";
        document.getElementById("searchResults").style.display = "none";
    }

    function removeStandard(standardCode) {
        if (!currentProject) return;

        const projects = getProjects();
        const projectIndex = projects.findIndex(p => p.id === currentProject.id);

        if (projectIndex === -1) return;

        projects[projectIndex].standards =
            projects[projectIndex].standards.filter(code => code !== standardCode);

        saveProjects(projects);
        currentProject = projects[projectIndex];
        renderStandards();
    }

    function exportToExcel() {
        if (!currentProject) return;

        let csvContent = "Ú©Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯,Ø¹Ù†ÙˆØ§Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯,ØªÙˆØ¶ÛŒØ­Ø§Øª,Ù„ÛŒÙ†Ú©\n";

        currentProject.standards.forEach(standardCode => {
            const standard = data.find(item => item.code === standardCode);
            if (standard) {
                csvContent += `"${standard.code}","${standard.desc}","${standard.details}","${standard.link}"\n`;
            }
        });

        const blob = new Blob(["\uFEFF" + csvContent], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ_${currentProject.name}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportToPDF(projectId) {
        var project = currentProject;
        // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ PDF
        const pdfContainer = document.createElement("div");
        pdfContainer.style.direction = "rtl";
        pdfContainer.style.fontFamily = "'Vazir', sans-serif";
        pdfContainer.style.padding = "20px";

        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø¯Ø± Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
        const header = document.createElement("div");
        header.style.background = "linear-gradient(135deg, #1565c0, #2196f3)";
        header.style.color = "white";
        header.style.padding = "25px";
        header.style.borderRadius = "10px";
        header.style.marginBottom = "25px";
        header.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
        header.style.textAlign = "center";

        header.innerHTML = `
    <h1 style="margin: 0; font-size: 28px; font-weight: 600;">${project.name}</h1>
    <h2 style="margin: 8px 0 0; font-size: 20px; font-weight: 400;">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡: ${project.number}</h2>
    ${project.description ? `<p style="margin: 15px 0 0; font-size: 16px; line-height: 1.6;">${project.description}</p>` : ''}
  `;

        pdfContainer.appendChild(header);

        // Ø¨Ø®Ø´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
        const standardsSection = document.createElement("div");
        standardsSection.style.marginTop = "30px";

        const standardsTitle = document.createElement("h2");
        standardsTitle.textContent = "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·";
        standardsTitle.style.color = "#1565c0";
        standardsTitle.style.borderBottom = "2px solid #1565c0";
        standardsTitle.style.paddingBottom = "8px";
        standardsTitle.style.fontSize = "22px";
        standardsSection.appendChild(standardsTitle);

        // Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§
        const standardsList = document.createElement("div");
        standardsList.style.marginTop = "15px";

        const standards = project.standards || [];
        if (standards.length === 0) {
            standardsList.innerHTML = `
      <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px; color: #666;">
        Ù‡ÛŒÚ† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
      </div>
    `;
        } else {
            standards.forEach(standardCode => {
                const standard = data.find(item => item.code === standardCode);
                if (standard) {
                    const standardCard = document.createElement("div");
                    standardCard.style.background = "white";
                    standardCard.style.borderRadius = "8px";
                    standardCard.style.padding = "15px";
                    standardCard.style.margin = "15px 0";
                    standardCard.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
                    standardCard.style.borderLeft = "4px solid #2196f3";

                    standardCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #1565c0; font-size: 18px;">${standard.code}</h3>
            <a href="${standard.link}" target="_blank" style="color: #2196f3; text-decoration: none; font-size: 14px;">
              Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
            </a>
          </div>
          <p style="margin: 10px 0 5px; font-weight: 500; color: #333;">${standard.desc}</p>
          <p style="margin: 5px 0 0; color: #555; font-size: 14px; line-height: 1.5;">${standard.details}</p>
        `;

                    standardsList.appendChild(standardCard);
                }
            });
        }

        standardsSection.appendChild(standardsList);
        pdfContainer.appendChild(standardsSection);

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÙˆØªØ±
        const footer = document.createElement("div");
        footer.style.marginTop = "30px";
        footer.style.paddingTop = "15px";
        footer.style.borderTop = "1px solid #eee";
        footer.style.textAlign = "center";
        footer.style.color = "#666";
        footer.style.fontSize = "12px";

        const now = new Date();
        const dateOptions = {year: 'numeric', month: 'long', day: 'numeric'};
        footer.textContent = `ØªØ§Ø±ÛŒØ® Ø®Ø±ÙˆØ¬ÛŒ: ${now.toLocaleDateString('fa-IR', dateOptions)}`;

        pdfContainer.appendChild(footer);

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¨Ù‡ ØµÙØ­Ù‡ (Ù…ÙˆÙ‚ØªØ§Ù‹)
        document.body.appendChild(pdfContainer);

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª PDF
        const pdfOptions = {
            margin: 15,
            filename: `Ø¬Ø²Ø¦ÛŒØ§Øª_Ù¾Ø±ÙˆÚ˜Ù‡_${project.name.replace(/\s+/g, '_')}.pdf`,
            image: {type: 'jpeg', quality: 0.98},
            html2canvas: {
                scale: 2,
                useCORS: true,
                letterRendering: true,
                logging: true
            },
            jsPDF: {
                unit: 'mm',
                format: 'a4',
                orientation: 'portrait'
            }
        };

        // Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ PDF
        html2pdf()
            .set(pdfOptions)
            .from(pdfContainer)
            .save()
            .then(() => {
                document.body.removeChild(pdfContainer);
            });
    }

    function exportToPDF() {
        if (!currentProject) return;

        const tempDiv = document.createElement("div");
        tempDiv.style.direction = "rtl";
        tempDiv.style.fontFamily = "'Vazir', sans-serif";
        console.log(currentProject);
        tempDiv.innerHTML = `
    <center style="font-weight: bold; color: blue">Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ${currentProject.name} </center>
    <center>${currentProject.description}</center>
    <table border="1" cellpadding="5" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>Ú©Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</th>
          <th>Ø¹Ù†ÙˆØ§Ù†</th>
          <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        
        ${currentProject.standards.map(standardCode => {
            const standard = data.find(item => item.code === standardCode);
            return standard ? `
            <tr>
              <td>${standard.code}</td>
              <td>${standard.desc}</td>
              <td>${standard.details}</td>
            </tr>
          ` : "";
        }).join("")}
      </tbody>
    </table>
  `;

        const opt = {
            margin: 0.5,
            filename: `Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ_${currentProject.name}.pdf`,
            image: {type: 'jpeg', quality: 0.98},
            html2canvas: {scale: 2},
            jsPDF: {unit: 'cm', format: 'a4', orientation: 'portrait'}
        };

        html2pdf().set(opt).from(tempDiv).save();
    }

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pagination.innerHTML = "";

        // ØªØ¹ÛŒÛŒÙ† Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´
        const maxVisiblePages = 5; // ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§ØªÛŒ Ú©Ù‡ Ø¯Ø± Ù‡Ø± Ù„Ø­Ø¸Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        let startPage, endPage;

        if (totalPages <= maxVisiblePages) {
            // Ø§Ú¯Ø± ØµÙØ­Ø§Øª Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø´Ù†Ø¯
            startPage = 1;
            endPage = totalPages;
        } else {
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØµÙØ­Ø§Øª Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
            const half = Math.floor(maxVisiblePages / 2);
            if (currentPage <= half + 1) {
                startPage = 1;
                endPage = maxVisiblePages;
            } else if (currentPage >= totalPages - half) {
                startPage = totalPages - maxVisiblePages + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - half;
                endPage = currentPage + half;
            }
        }

        // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Previous Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯
        if (currentPage > 1) {
            const prevBtn = document.createElement("button");
            prevBtn.innerHTML = "&laquo; Ù‚Ø¨Ù„ÛŒ";
            prevBtn.onclick = () => {
                currentPage--;
                render();
            };
            pagination.appendChild(prevBtn);
        }

        // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ø§Øª
        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            if (i === currentPage) {
                btn.classList.add("active");
                btn.disabled = true;
            }
            btn.onclick = () => {
                currentPage = i;
                render();
            };
            pagination.appendChild(btn);
        }

        // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Next Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯
        if (currentPage < totalPages) {
            const nextBtn = document.createElement("button");
            nextBtn.innerHTML = "Ø¨Ø¹Ø¯ÛŒ &raquo;";
            nextBtn.onclick = () => {
                currentPage++;
                render();
            };
            pagination.appendChild(nextBtn);
        }
    }

    // Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† (Ù‡Ø´ SHA-256 Ø±Ù…Ø² "admin")
    const ADMIN_PASSWORD_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";

    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
    function openAdminPanel() {
        document.getElementById('adminPanel').classList.add('open');
        document.getElementById('adminOverlay').classList.add('active');

        // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ†
        checkAdminStatus().then(() => {
            if (isAdminLoggedIn) {
                showAdminSection('manageStandards');
            } else {
                alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹!');
                closeAdminPanel();
            }
        });
    }

    function closeAdminPanel() {
        document.getElementById('adminPanel').classList.remove('open');
        document.getElementById('adminOverlay').classList.remove('active');
    }

    function resetAdminPanel() {
        isAdminLoggedIn = false;
        const adminLoginContainer = document.getElementById('adminLoginContainer');
        const adminMenuContainer = document.getElementById('adminMenuContainer');
        const manageStandardsContainer = document.getElementById('manageStandardsContainer');

        if (adminLoginContainer) adminLoginContainer.style.display = 'block';
        if (adminMenuContainer) adminMenuContainer.style.display = 'none';
        if (manageStandardsContainer) manageStandardsContainer.style.display = 'none';

        const adminPanelTitle = document.getElementById('adminPanelTitle');
        if (adminPanelTitle) adminPanelTitle.textContent = 'Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†';

        const adminPassword = document.getElementById('adminPassword');
        if (adminPassword) adminPassword.value = '';

        // Ø±ÛŒØ³Øª Ø¢ÛŒÚ©ÙˆÙ†
        const adminBtn = document.querySelector('.icon-btn[onclick="openAdminPanel()"] i');
        if (adminBtn) {
            adminBtn.setAttribute('data-lucide', 'shield');
            lucide.createIcons();
        }
    }

    async function adminLogin() {
        const passwordInput = document.getElementById('adminPassword');
        if (!passwordInput) {
            console.error('Ø¹Ù†ØµØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯');
            return;
        }

        const password = passwordInput.value;

        try {
            const hash = await sha256(password);

            if (hash === ADMIN_PASSWORD_HASH) {
                // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© ØªÙˆÚ©Ù† ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ session
                const sessionToken = generateSessionToken();
                const tokenHash = await sha256(sessionToken + ADMIN_PASSWORD_HASH);

                // Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù† Ø¯Ø± localStorage
                localStorage.setItem('adminAuthToken', tokenHash);
                localStorage.setItem('adminSessionToken', sessionToken);
                // Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ (1 Ø³Ø§Ø¹Øª)
                localStorage.setItem('adminAuthExpire', Date.now() + 3600000);

                // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ UI
                isAdminLoggedIn = true;

                const adminLoginContainer = document.getElementById('adminLoginContainer');
                const adminMenuContainer = document.getElementById('adminMenuContainer');
                const adminPanelTitle = document.getElementById('adminPanelTitle');

                if (adminLoginContainer) adminLoginContainer.style.display = 'none';
                if (adminMenuContainer) adminMenuContainer.style.display = 'block';
                if (adminPanelTitle) adminPanelTitle.textContent = 'Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ† - Ø³ÛŒØ³ØªÙ…';

                showAdminSection('mainMenu');

                // Ø¢Ù¾Ø¯ÛŒØª Ø¢ÛŒÚ©ÙˆÙ†
                const adminBtn = document.querySelector('.icon-btn[onclick="openAdminPanel()"] i');
                if (adminBtn) {
                    adminBtn.setAttribute('data-lucide', 'shield-check');
                    lucide.createIcons();
                }
            } else {
                alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!');
            }
        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:', error);
            alert('Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª');
        }
    }

    function generateSessionToken() {
        const array = new Uint32Array(10);
        window.crypto.getRandomValues(array);
        return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
    }

    async function checkAdminLogin() {
        const token = localStorage.getItem('adminAuthToken');
        const expire = localStorage.getItem('adminAuthExpire');
        const sessionToken = localStorage.getItem('adminSessionToken');

        if (!token || !expire || !sessionToken || Date.now() > parseInt(expire)) {
            resetAdminPanel();
            return false;
        }

        try {
            const validToken = await sha256(sessionToken + ADMIN_PASSWORD_HASH);

            if (token === validToken) {
                isAdminLoggedIn = true;

                const adminLoginContainer = document.getElementById('adminLoginContainer');
                const adminMenuContainer = document.getElementById('adminMenuContainer');
                const adminPanelTitle = document.getElementById('adminPanelTitle');

                if (adminLoginContainer) adminLoginContainer.style.display = 'none';
                if (adminMenuContainer) adminMenuContainer.style.display = 'block';
                if (adminPanelTitle) adminPanelTitle.textContent = 'Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ† - Ø³ÛŒØ³ØªÙ…';

                showAdminSection('mainMenu');

                // Ø¢Ù¾Ø¯ÛŒØª Ø¢ÛŒÚ©ÙˆÙ†
                const adminBtn = document.querySelector('.icon-btn[onclick="openAdminPanel()"] i');
                if (adminBtn) {
                    adminBtn.setAttribute('data-lucide', 'shield-check');
                    lucide.createIcons();
                }

                return true;
            }
        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± ÙˆØ±ÙˆØ¯:', error);
        }

        resetAdminPanel();
        return false;
    }

    function adminLogout() {
        localStorage.removeItem('adminAuthToken');
        localStorage.removeItem('adminAuthExpire');
        localStorage.removeItem('adminSessionToken');
        resetAdminPanel();
    }

    function showAdminSection(section) {
        document.getElementById('adminMenuContainer').style.display = 'none';
        document.getElementById('manageStandardsContainer').style.display = 'none';

        if (section === 'manageStandards') {
            document.getElementById('manageStandardsContainer').style.display = 'block';
            loadCategoriesForAdmin();
            searchAdminStandards();
        }
        // Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯

    }

    // function showAdminSection(section) {
    //     // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§
    //     document.getElementById('manageStandardsContainer').style.display = 'none';
    //
    //     if (section === 'manageStandards') {
    //         document.getElementById('manageStandardsContainer').style.display = 'block';
    //         loadCategoriesForAdmin();
    //         searchAdminStandards();
    //     }
    // }

    // ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ø´ SHA-256
    // async function sha256(message) {
    //     // encode as UTF-8
    //     const msgBuffer = new TextEncoder().encode(message);
    //
    //     // hash the message
    //     const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    //
    //     // convert ArrayBuffer to Array
    //     const hashArray = Array.from(new Uint8Array(hashBuffer));
    //
    //     // convert bytes to hex string
    //     const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    //     return hashHex;
    // }
    async function sha256(message) {
        return CryptoJS.SHA256(message).toString(CryptoJS.enc.Hex);
    }

    let editingStandardId = null; // null Ø¨Ù‡ Ù…Ø¹Ù†ÛŒ Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¬Ø¯ÛŒØ¯
    let isEditingMode = false; // Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø§ÙØ²ÙˆØ¯Ù†
    async function searchAdminStandards() {
        const searchTerm = document.getElementById('adminStandardSearch').value;
        try {
            const response = await fetch(`/api/standards/?search=${encodeURIComponent(searchTerm)}`, {
                credentials: 'include'
            });
            const standards = await response.json();
            renderAdminStandards(standards);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderAdminStandards(standards) {
        const list = document.getElementById('adminStandardsList');
        list.innerHTML = standards.map(standard => `
        <div class="standard-item">
            <div>
                <strong>${standard.code}</strong> - ${standard.desc}
                <div class="text-muted">${standard.category}</div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="editStandard(${standard.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger" onclick="deleteStandard(${standard.id})">Ø­Ø°Ù</button>
            </div>
        </div>
    `).join('');
    }

    async function deleteStandard(standardId) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

        try {
            const response = await fetch(`/api/standards/${standardId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (response.ok) {
                await searchAdminStandards();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function editStandard(standardId) {
        try {
            const response = await fetch(`/api/standards/${standardId}`, {
                credentials: 'include'
            });
            const standard = await response.json();

            // ØªÙ†Ø¸ÛŒÙ… Ø´Ù†Ø§Ø³Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´
            editingStandardId = standardId; // <-- Ø§ÛŒÙ† Ø®Ø· Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
            isEditingMode = true;
            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´
            document.getElementById('editCode').value = standard.code;
            document.getElementById('editDesc').value = standard.desc;
            const categorySelect = document.getElementById('editCategory');
            categorySelect.value = standard.category; // <-- Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù‚Ø¯Ø§Ø±
            document.getElementById('editDetails').value = standard.details;
            document.getElementById('editLink').value = standard.link;

            document.getElementById('adminStandardsList').style.display = 'none';
            document.getElementById('editStandardContainer').style.display = 'block';
        } catch (error) {
            console.error('Error:', error);
        }
    }


    function showAddStandardForm() {
        // Ø±ÛŒØ³Øª ÙØ±Ù… Ùˆ ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù†
        editingStandardId = null;
        isEditingMode = false;

        document.getElementById('editCode').value = '';
        document.getElementById('editDesc').value = '';
        document.getElementById('editCategory').value = '';
        document.getElementById('editDetails').value = '';
        document.getElementById('editLink').value = '';

        document.getElementById('adminStandardsList').style.display = 'none';
        document.getElementById('editStandardContainer').style.display = 'block';
    }

    async function saveEditedStandard() {
        const standardData = {
            code: document.getElementById('editCode').value,
            desc: document.getElementById('editDesc').value,
            category: document.getElementById('editCategory').value,
            details: document.getElementById('editDetails').value,
            link: document.getElementById('editLink').value
        };

        try {
            let url, method;

            if (isEditingMode) {
                // Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´: PUT
                url = `/api/standards/${editingStandardId}`;
                method = 'PUT';
            } else {
                // Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù†: POST
                url = '/api/standards/';
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(standardData)
            });

            if (response.ok) {
                await searchAdminStandards();
                cancelEditStandard();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function cancelEditStandard() {
        editingStandardId = null;
        isEditingMode = false;

        document.getElementById('adminStandardsList').style.display = 'block';
        document.getElementById('editStandardContainer').style.display = 'none';
    }

    function openProfilePanel() {
        document.getElementById('profilePanel').classList.add('open');
        document.getElementById('profileOverlay').classList.add('active');
        loadProfileInfo();
    }

    function closeProfilePanel() {
        document.getElementById('profilePanel').classList.remove('open');
        document.getElementById('profileOverlay').classList.remove('active');
    }

    async function loadProfileInfo() {
        try {
            const response = await fetch('/api/user/profile', {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load profile');
            }

            const userData = await response.json();

            document.getElementById('profileUsername').textContent = userData.username;
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('profileFullName').textContent = userData.full_name;

            const joinDate = new Date(userData.created_at);
            document.getElementById('profileJoinDate').textContent = `Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡ Ø¯Ø±: ${joinDate.toLocaleDateString('fa-IR')}`;

            lucide.createIcons();
        } catch (error) {
            console.error('Error loading profile:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„');
        }
    }

    function showChangePasswordForm() {
        document.getElementById('profileInfo').style.display = 'none';
        document.getElementById('changePasswordForm').style.display = 'block';
    }

    function cancelChangePassword() {
        document.getElementById('profileInfo').style.display = 'block';
        document.getElementById('changePasswordForm').style.display = 'none';
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    }

    async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯');
            return;
        }

        try {
            const response = await fetch('/api/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to change password');
            }

            alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
            cancelChangePassword();
        } catch (error) {
            console.error('Error changing password:', error);
            alert(`Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: ${error.message}`);
        }
    }

    async function logout() {
        try {
            const response = await fetch('/logout/', {
                method: 'POST',
                credentials: 'include'
            });

            if (response.ok) {
                window.location.href = '/login/';
            } else {
                throw new Error('Failed to logout');
            }
        } catch (error) {
            console.error('Error logging out:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨');
        }
    }

    async function loadCategoriesForAdmin() {
        try {
            const response = await fetch('/api/categories/', {
                credentials: 'include'
            });
            const categories = await response.json();

            const categorySelect = document.getElementById('editCategory');
            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
            categorySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>';

            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
</script>
</body>

</html>